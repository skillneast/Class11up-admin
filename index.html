<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --primary-bg: #141b2d; --secondary-bg: #1f2a40; --card-bg: #293651; --button-color: #868dfb; --danger-color: #ff7e5f; --edit-color: #45b6fe; --green-color: #2ecc71; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: white; font-size: 14px; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        h2, h3, h4, h5, h6 { border-bottom: 1px solid var(--button-color); padding-bottom: 10px; margin-bottom: 20px; }
        h4, h5, h6 { border-bottom-style: dashed; font-size: 1em; margin-top: 20px;}
        h5, h6 { border-color: var(--card-bg); }
        .section { background-color: var(--secondary-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; font-family: 'Poppins', sans-serif; font-size: 1em; }
        input, select { background-color: var(--card-bg); color: white; }
        button { background-color: var(--button-color); color: white; font-weight: 600; cursor: pointer; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        
        .stats-section { display: flex; justify-content: space-around; text-align: center; }
        .stat-item h4 { border-bottom: none; margin-bottom: 5px; }
        .stat-item .count { font-size: 2em; font-weight: 600; }
        .stat-item .realtime .count { color: var(--green-color); }

        .item { display: flex; align-items: center; background-color: var(--card-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; }
        .item-title { font-weight: 500; flex-grow: 1; margin-left: 10px; }
        .item-actions { display: flex; gap: 10px; margin-left: auto; }
        .action-btn { background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 5px;}
        .action-btn.edit-btn { color: var(--edit-color); }
        .action-btn.delete-btn { color: var(--danger-color); }
        .toggle-btn { cursor: pointer; transition: transform 0.3s; }
        .toggle-btn.collapsed { transform: rotate(-90deg); }
        .nested-section { border-left: 3px solid var(--button-color); padding-left: 15px; margin-top: 15px; }
        .collapsible-content.collapsed { display: none; }
        .add-content-form { padding: 15px; background-color: var(--primary-bg); border-radius: 8px; margin-top: 10px;}
        .batch-collapsible-content.collapsed { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h2><i class="fas fa-cogs"></i> Website Admin Panel</h2>

    <div class="section stats-section">
        <div class="stat-item realtime"><h4><i class="fas fa-signal"></i> Realtime Users</h4><div id="realtime-users" class="count">0</div></div>
        <div class="stat-item"><h4><i class="fas fa-users"></i> Total Visits</h4><div id="total-visits" class="count">0</div></div>
    </div>

    <div class="section">
        <h3><i class="fas fa-globe"></i> General Settings</h3>
        <input type="text" id="logo-link" placeholder="Logo Link">
        <input type="text" id="telegram-link" placeholder="Telegram Channel Link">
        <input type="text" id="contact-link" placeholder="Contact/Support Link">
        <button id="save-settings-btn">Save Settings</button>
    </div>

    <div class="section">
        <h3><i class="fas fa-layer-group"></i> Manage Batches</h3>
        <input type="text" id="batch-title" placeholder="New Batch Title">
        <input type="text" id="batch-image" placeholder="New Batch Image URL">
        <button id="add-batch-btn">Add New Batch</button>
        <div id="batches-list" class="item-list"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyC1m25mHpA59xBQmF34BfA1K_vY2pUSrLI",
      authDomain: "fahad-portfolio-81c65.firebaseapp.com",
      databaseURL: "https://fahad-portfolio-81c65-default-rtdb.firebaseio.com",
      projectId: "fahad-portfolio-81c65",
      storageBucket: "fahad-portfolio-81c65.firebasestorage.app",
      messagingSenderId: "510625882446",
      appId: "1:510625882446:web:b23f76808b3dd0e79a3e1f"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const settingsRef = ref(database, 'settings');
    document.getElementById('save-settings-btn').addEventListener('click', () => { set(settingsRef, { logoLink: document.getElementById('logo-link').value, telegramLink: document.getElementById('telegram-link').value, contactLink: document.getElementById('contact-link').value }); alert('Settings Saved!'); });
    onValue(settingsRef, (snapshot) => { const data = snapshot.val(); if (data) { document.getElementById('logo-link').value = data.logoLink || ''; document.getElementById('telegram-link').value = data.telegramLink || ''; document.getElementById('contact-link').value = data.contactLink || ''; }});

    onValue(ref(database, 'analytics/totalVisits'), s => { document.getElementById('total-visits').textContent = s.val() || 0; });
    onValue(ref(database, 'presences'), s => { document.getElementById('realtime-users').textContent = s.numChildren(); });
    
    const batchesRef = ref(database, 'batches');
    const batchesListDiv = document.getElementById('batches-list');
    let sortedBatches = [];

    document.getElementById('add-batch-btn').addEventListener('click', () => {
        const titleInput = document.getElementById('batch-title');
        const imageInput = document.getElementById('batch-image');
        if (titleInput.value && imageInput.value) {
            const newOrder = sortedBatches.length;
            push(batchesRef, { title: titleInput.value, imageUrl: imageInput.value, order: newOrder });
            titleInput.value = ''; imageInput.value = '';
        }
    });

    onValue(batchesRef, (snapshot) => {
        batchesListDiv.innerHTML = '';
        const batchesData = snapshot.val();
        if (batchesData) {
            sortedBatches = Object.entries(batchesData).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));
            sortedBatches.forEach(([batchId, batch], index) => {
                const batchElement = createBatchElement(batchId, batch, index, sortedBatches.length);
                batchesListDiv.appendChild(batchElement);
            });
        } else {
            sortedBatches = [];
            batchesListDiv.innerHTML = '<p>No batches found. Use the form above to add one.</p>';
        }
    });
    
    function createBatchElement(batchId, batch, index, total) {
        const container = document.createElement('div');
        container.className = 'section';

        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        itemDiv.innerHTML = `
            <i class="fas fa-chevron-down toggle-btn"></i>
            <span class="item-title">${batch.title}</span>
            <div class="item-actions">
                <button class="action-btn reorder-up-btn" data-index="${index}" ${index === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i></button>
                <button class="action-btn reorder-down-btn" data-index="${index}" ${index === total - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i></button>
                <button class="action-btn edit-btn" data-path="batches/${batchId}" data-current-title="${batch.title}"><i class="fas fa-pencil-alt"></i></button>
                <button class="action-btn delete-btn" data-path="batches/${batchId}"><i class="fas fa-trash"></i></button>
            </div>`;
        container.appendChild(itemDiv);

        const subjectsSection = document.createElement('div');
        subjectsSection.className = 'nested-section batch-collapsible-content';
        subjectsSection.innerHTML = `<h4>Subjects in ${batch.title}</h4>`;
        if (batch.subjects) {
            for (const subjectId in batch.subjects) {
                subjectsSection.appendChild(createSubjectElement(batchId, subjectId, batch.subjects[subjectId]));
            }
        }
        subjectsSection.innerHTML += `<h4>Add Subject</h4><input type="text" class="subject-title" placeholder="New Subject Title"><button class="add-subject-btn" data-batch-id="${batchId}">Add Subject</button>`;
        container.appendChild(subjectsSection);
        return container;
    }

    function createSubjectElement(batchId, subjectId, subject) {
        const container = document.createElement('div');
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        itemDiv.innerHTML = `<i class="fas fa-chevron-down toggle-btn collapsed"></i> <span class="item-title">${subject.title}</span><div class="item-actions"><button class="action-btn edit-btn" data-path="batches/${batchId}/subjects/${subjectId}" data-current-title="${subject.title}"><i class="fas fa-pencil-alt"></i></button><button class="action-btn delete-btn" data-path="batches/${batchId}/subjects/${subjectId}"><i class="fas fa-trash"></i></button></div>`;
        container.appendChild(itemDiv);

        const chaptersSection = document.createElement('div');
        chaptersSection.className = 'nested-section collapsible-content collapsed';
        chaptersSection.style.backgroundColor = 'var(--primary-bg)';
        chaptersSection.innerHTML = `<h5>Chapters in ${subject.title}</h5>`;
        if (subject.chapters) {
            for (const chapterId in subject.chapters) {
                chaptersSection.appendChild(createChapterElement(batchId, subjectId, chapterId, subject.chapters[chapterId]));
            }
        }
        chaptersSection.innerHTML += `<h5>Add Chapter</h5><input type="text" class="chapter-title" placeholder="New Chapter Title"><button class="add-chapter-btn" data-batch-id="${batchId}" data-subject-id="${subjectId}">Add Chapter</button>`;
        container.appendChild(chaptersSection);
        return container;
    }

    function createChapterElement(batchId, subjectId, chapterId, chapter) {
        const container = document.createElement('div');
        container.style.marginBottom = '15px';
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `<i class="fas fa-chevron-down toggle-btn collapsed"></i><span class="item-title">${chapter.title}</span><div class="item-actions"><button class="action-btn edit-btn" data-path="batches/${batchId}/subjects/${subjectId}/chapters/${chapterId}" data-current-title="${chapter.title}"><i class="fas fa-pencil-alt"></i></button><button class="action-btn delete-btn" data-path="batches/${batchId}/subjects/${subjectId}/chapters/${chapterId}"><i class="fas fa-trash"></i></button></div>`;
        container.appendChild(item);

        const contentListSection = document.createElement('div');
        contentListSection.className = 'collapsible-content collapsed';
        if (chapter.content) {
            contentListSection.innerHTML += `<h6>Content in ${chapter.title}</h6>`;
            Object.entries(chapter.content).forEach(([contentId, contentItem]) => {
                contentListSection.innerHTML += `<div class="item"><span class="item-title">[${contentItem.type}] ${contentItem.title}</span><div class="item-actions"><button class="action-btn edit-btn" data-path="batches/${batchId}/subjects/${subjectId}/chapters/${chapterId}/content/${contentId}" data-current-title="${contentItem.title}" data-current-url="${contentItem.url}"><i class="fas fa-pencil-alt"></i></button><button class="action-btn delete-btn" data-path="batches/${batchId}/subjects/${subjectId}/chapters/${chapterId}/content/${contentId}"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }
        container.appendChild(contentListSection);
        
        const addContentForm = document.createElement('div');
        addContentForm.className = 'add-content-form';
        const lastType = sessionStorage.getItem('lastContentType') || 'lecture';
        addContentForm.innerHTML = `<h6>Add Content to ${chapter.title}</h6>
            <select class="content-type">
                <option value="lecture" ${lastType === 'lecture' ? 'selected' : ''}>Lecture</option>
                <option value="note" ${lastType === 'note' ? 'selected' : ''}>Note</option>
                <option value="dpp" ${lastType === 'dpp' ? 'selected' : ''}>DPP</option>
            </select>
            <input type="text" class="content-title" placeholder="Content Title"><input type="text" class="content-url" placeholder="Content Link/URL">
            <button class="add-content-btn" data-batch-id="${batchId}" data-subject-id="${subjectId}" data-chapter-id="${chapterId}">Add Content</button>`;
        container.appendChild(addContentForm);
        return container;
    }

    batchesListDiv.addEventListener('click', async e => {
        const target = e.target;
        const button = target.closest('button');
        const toggle = target.closest('.toggle-btn');
        
        if (button) {
            e.stopPropagation();
            const path = button.dataset.path;
            if (button.matches('.reorder-up-btn, .reorder-down-btn')) {
                const index = parseInt(button.dataset.index, 10);
                const direction = button.matches('.reorder-up-btn') ? -1 : 1;
                const otherIndex = index + direction;
                if (otherIndex >= 0 && otherIndex < sortedBatches.length) {
                    const [currentKey, currentBatch] = sortedBatches[index];
                    const [otherKey, otherBatch] = sortedBatches[otherIndex];
                    const updates = {};
                    updates[`batches/${currentKey}/order`] = otherBatch.order;
                    updates[`batches/${otherKey}/order`] = currentBatch.order;
                    await update(ref(database), updates);
                }
            }
            else if (button.classList.contains('delete-btn')) { if (confirm('Are you sure?')) remove(ref(database, path)); } 
            else if(button.classList.contains('edit-btn')){
                const currentTitle = button.dataset.currentTitle;
                const newTitle = prompt("Enter new title:", currentTitle);
                if(newTitle !== null && newTitle.trim()) {
                    const currentUrl = button.dataset.currentUrl;
                    if(currentUrl !== undefined) {
                        const newUrl = prompt("Enter new URL:", currentUrl);
                        if(newUrl !== null) update(ref(database, path), { title: newTitle, url: newUrl });
                    } else {
                        update(ref(database, path), { title: newTitle });
                    }
                }
            }
            else if (button.matches('.add-subject-btn')) { const batchId = button.dataset.batchId; const input = button.previousElementSibling; if (input.value) { push(ref(database, `batches/${batchId}/subjects`), { title: input.value }); input.value = ''; } }
            else if (button.matches('.add-chapter-btn')) { const { batchId, subjectId } = button.dataset; const input = button.previousElementSibling; if (input.value) { push(ref(database, `batches/${batchId}/subjects/${subjectId}/chapters`), { title: input.value }); input.value = ''; } }
            else if (button.matches('.add-content-btn')) {
                const { batchId, subjectId, chapterId } = button.dataset;
                const form = button.closest('.add-content-form');
                const type = form.querySelector('.content-type').value;
                const titleInput = form.querySelector('.content-title');
                const urlInput = form.querySelector('.content-url');
                if (titleInput.value && urlInput.value) {
                    sessionStorage.setItem('lastContentType', type);
                    push(ref(database, `batches/${batchId}/subjects/${subjectId}/chapters/${chapterId}/content`), { type, title: titleInput.value, url: urlInput.value }); 
                    titleInput.value = ''; urlInput.value = ''; 
                }
            }
        } else if (toggle) {
            toggle.classList.toggle('collapsed');
            const collapsible = toggle.closest('.item').nextElementSibling;
            if (collapsible) {
                collapsible.classList.toggle('collapsed');
            }
        }
    });
</script>
</body>
</html>
